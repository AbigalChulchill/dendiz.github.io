<html lang="en">
    <head>
      <title>Deniz's personal pages</title>
      <meta charset="utf-8">
      <meta name="viewport" content="initial-scale=1">
      <link rel="stylesheet" href="/css/style.css" />
      <!--script src="/js/vendor/es5-shim.min.js"></script>
      <script src="/js/vendor/ansi_up.min.js"></script>
      <script src="/js/vendor/prism.min.js"></script>
      <script src="/js/vendor/katex.min.js"></script>
      <script src="/js/vendor/katex-auto-render.min.js"></script>
      <link rel="stylesheet" href="/css/vendor/katex.min.css" />
      <link href="https://fonts.googleapis.com/css?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900|Roboto+Mono:300,300i,400,400i,500,500i,700,700i&amp;display=swap" rel="stylesheet"-->
    </head>
    <body>
        <div>
        <a href="/micro/micro-index.html" onClick="this.href+='?rnd='+new Date().getTime()">Micro</a> | 
        <a href="/post/index.html" onClick="this.href+='?rnd='+new Date().getTime()">Macro</a> | 
        <a href="/post/about.html">About</a>
        </div>
        <hr />
        <div id="main">
        <h1 id="title"> Efficient calculation of bollinger bands</h1>
        <div id="date"><em> 2018-08-21</em></div>
        <p>The Bollinger bands used in technical analysis is the +/- 2 * standard deviation of the closing price plotted on the chart.
This prices are expected to fluctuate in this band 95% of the time. As with any sliding window calculation the easy way is
to calculate everything each time for each window. Which usually means quadratic algorithm. A better way exists to calculate
the values for standard deviations using some smart manipulations on the standard deviation formula. (to be more precise the
variance formula which is the square of the standard deviation.)</p>
<p>To the variance formula is (k = )</p>
<p>$$ \sum_{i=1}^{n} (price_i - mean)^2 $$</p>
<p>expanding the quadratic term</p>
<p>$$ \sum_{i=1}^{n} (price_i^2 - 2 \times price_i \times mean + mean^2) $$</p>
<p>extracting the last constant term independent of i</p>
<p>$$ \sum_{i=1}^{n} (price_i^2 - 2 \times price_i \times mean) + n \times mean^2 $$</p>
<p>extract the term independent of i from the 2nd part</p>
<p>$$ \sum_{i=1}^{n} (price_i^2) + \sum_{i=1}^{n}(-2 \times price_i) \times mean + n \times mean^2 $$</p>
<p>first term and last term can be handled the way moving averages are handle. When the window slides right, add the new term
remove the old term on the left. This is efficient.</p>
<p>$$ \sum_{i=1}^{n} price_i = total = mean \times n $$</p>
<p>so the middle term becomes</p>
<p>$$ -2 \times mean^2 \times n $$</p>
<p>now the second term can also be calculated using the efficient method.</p>
<p>Here is an implementation in code for bollinger bands</p>
<pre><code class="language-java">public SuperList&lt;BollingerBand&gt; calculate() {
    double totalAvg = 0d;
    double totalSq = 0d;
    int i = 0;
    SuperList&lt;BollingerBand&gt; result = new SuperList&lt;&gt;();
    for (Double value : values) {
        totalAvg += value;
        totalSq += value * value;
        if (i &gt;= PERIOD - 1) {
            double avg = totalAvg / PERIOD;
            double stddev = Math.sqrt((totalSq - (totalAvg*totalAvg)/PERIOD)/ PERIOD);
            BollingerBand band = new BollingerBand(avg, avg + 2 * stddev, avg - 2 * stddev);
            result.add(band);
            totalAvg -= values.get(i - PERIOD + 1);
            totalSq -= values.get(i - PERIOD + 1) * values.get(i - PERIOD + 1);
        }
        i++;
    }
    return result;
}
</code></pre>

        </div>
    </body>
</html>
