<html lang="en">
    <head>
      <title>Deniz's personal pages</title>
      <meta charset="utf-8">
      <meta name="viewport" content="initial-scale=1">
      <!--script src="/js/vendor/es5-shim.min.js"></script>
      <script src="/js/vendor/ansi_up.min.js"></script>
      <script src="/js/vendor/prism.min.js"></script>
      <script src="/js/vendor/katex.min.js"></script>
      <script src="/js/vendor/katex-auto-render.min.js"></script>
      <link rel="stylesheet" href="/css/vendor/katex.min.css" />
      <link href="https://fonts.googleapis.com/css?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900|Roboto+Mono:300,300i,400,400i,500,500i,700,700i&amp;display=swap" rel="stylesheet"-->
    </head>
    <body>
        <div>
        <a href="/micro/micro-index.html?_=1632183091.6929648">Micro</a> | 
        <a href="/post/index.html?_=1632183091.6929648">Macro</a> | 
        <a href="/post/about.html">About</a>
        </div>
        <hr />
        <div id="main">
        <h1 id="title"> Local dns server</h1>
        <div id="date"><em> 2020-04-01</em></div>
        <p>I have a bunch of self hosted services running in containers on my docker host and it was getting pretty hard to keep track of which port was assigned to what. I wanted to setup an nginx proxy that would be the front end to all these services and also wanted to use human friendly addresses. The simple option would be to add all the hostnames to my <code>etc/resolv.conf</code> file but I use 5 different devices daily and some of them don't even allow me to change that file. So I needed to run my own DNS server. The idea was to capture requests made to <code>*.dendiz.lan</code> and resolve them to my docker host and forward all other requests to my usual DNS servers.</p>
<p>DNS configs can be tricky but a project called coredns makes it very simple. The DNS itself is also a docker container which keeps things even cleaner. So I spun up a coredns container with following dns records file</p>
<pre><code>$ORIGIN dendiz.lan.
@	3600 IN	SOA sns.dns.icann.org. noc.dns.icann.org. (
    			2017042745 ; serial
    			7200       ; refresh (2 hours)
    			3600       ; retry (1 hour)
    			1209600    ; expire (2 weeks)
    			3600       ; minimum (1 hour)
    			)

    3600 IN NS a.iana-servers.net.
    3600 IN NS b.iana-servers.net.

*.dendiz.lan.     IN A     192.168.0.60
          IN AAAA     192.168.0.60
</code></pre>
<p>and the config file</p>
<pre><code>dendiz.lan:53 {
    file db.dendiz.lan
    errors
    log
}

. {
    any
    forward . 8.8.8.8:53
    errors
    log
}
</code></pre>
<p>so any requests to dendiz.lan are resolved using my dns record file which uses a wildcard to resolve them to my docker hosts ip. I built the executable, created the docker image and started the container. Ran a bunch dig requests like</p>
<pre><code>dig @localhost -p 53 www.dendiz.lan A
</code></pre>
<p>and got back an answer section. Nice! Next up creating the proxies... I found a nice project called nginx proxy manager that provides a web interface for creating proxy configs which also runs in a container. I installed that and created proxy hosts for all the services that I use and everything was looking good. one caveat with this setup is that I had manually set the DNS servers in the network settings on my devices. The solution to this issue was to configure my routers internet settings and put in my DNS server as the first server to use. Now all the devices that use DHCP can resolve my local domain.</p>

        </div>
    </body>
</html>
