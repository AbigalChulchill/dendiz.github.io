<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Local dns server</title>
      <meta charset="utf-8">
      <meta name="viewport" content="initial-scale=1">
      <link rel="stylesheet" href="/css/style.css">
    </head>
    <body>
        <div>
        <strong>
        <a href="/micro/micro-index.html" onClick="this.href+='?rnd='+new Date().getTime()">Micro</a> &middot; 
        <a href="/post/index.html" onClick="this.href+='?rnd='+new Date().getTime()">Macro</a> &middot; 
        <a href="/post/about.html">About</a> &middot; 
        <a href="/post/now.html">Now</a> &middot; 
        <a href="/post/fn.html">fn</a>
        &middot;
        <a href="/twtxt.txt">twtxt</a>
        </strong>
        </div>
        <hr />
        <div id="main">
        <h1 id="title">Local dns server</h1>
        <div id="date"><em>created 2020-04-01 </em></div>
        <div class="content">
        <p>I have a bunch of self hosted services running in containers on my docker host and it was getting pretty hard to keep track of which port was assigned to what. I wanted to setup an nginx proxy that would be the front end to all these services and also wanted to use human friendly addresses. The simple option would be to add all the hostnames to my <code>etc/resolv.conf</code> file but I use 5 different devices daily and some of them don't even allow me to change that file. So I needed to run my own DNS server. The idea was to capture requests made to <code>*.dendiz.lan</code> and resolve them to my docker host and forward all other requests to my usual DNS servers.</p>
<p>DNS configs can be tricky but a project called coredns makes it very simple. The DNS itself is also a docker container which keeps things even cleaner. So I spun up a coredns container with following dns records file</p>
<pre><code>$ORIGIN dendiz.lan.
@	3600 IN	SOA sns.dns.icann.org. noc.dns.icann.org. (
    			2017042745 ; serial
    			7200       ; refresh (2 hours)
    			3600       ; retry (1 hour)
    			1209600    ; expire (2 weeks)
    			3600       ; minimum (1 hour)
    			)

    3600 IN NS a.iana-servers.net.
    3600 IN NS b.iana-servers.net.

*.dendiz.lan.     IN A     192.168.0.60
          IN AAAA     192.168.0.60
</code></pre>
<p>and the config file</p>
<pre><code>dendiz.lan:53 {
    file db.dendiz.lan
    errors
    log
}

. {
    any
    forward . 8.8.8.8:53
    errors
    log
}
</code></pre>
<p>so any requests to dendiz.lan are resolved using my dns record file which uses a wildcard to resolve them to my docker hosts ip. I built the executable, created the docker image and started the container. Ran a bunch dig requests like</p>
<pre><code>dig @localhost -p 53 www.dendiz.lan A
</code></pre>
<p>and got back an answer section. Nice! Next up creating the proxies... I found a nice project called nginx proxy manager that provides a web interface for creating proxy configs which also runs in a container. I installed that and created proxy hosts for all the services that I use and everything was looking good. one caveat with this setup is that I had manually set the DNS servers in the network settings on my devices. The solution to this issue was to configure my routers internet settings and put in my DNS server as the first server to use. Now all the devices that use DHCP can resolve my local domain.</p>

        </div>
        </div>
	<footer>
	<em>generated on 2021-10-15 23:09:32</em>
	</footer>
  Want to say something? Please <a href="mailto:deniz.dizmzn@gmail.com?subject=Local dns server">send</a> an email and I will update this post with our correspondance.
    </body>
</html>
