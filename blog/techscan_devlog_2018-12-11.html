<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Deniz's personal pages</title>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1">
        <script src="/js/vendor/es5-shim.min.js"></script>
        <script src="/js/vendor/marked.min.js"></script>
        <!--script src="/js/vendor/purify.min.js"></script-->
        <script src="/js/vendor/ansi_up.min.js"></script>
        <script src="/js/vendor/prism.min.js"></script>
        <script src="/js/vendor/katex.min.js"></script>
        <script src="/js/vendor/katex-auto-render.min.js"></script>
	<script src="/js/vendor/notebook.js?_=2021-08-22 11:26:49"></script>
        <link rel="stylesheet" href="/css/vendor/katex.min.css" />
        <link rel="stylesheet" href="/css/vendor/prism.css" />
	<link rel="stylesheet" href="/css/notebook.css?2021-08-22 11:26:49" />
	<link rel="stylesheet" href="/css/nbpreview.css?2021-08-22 11:26:49" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900|Roboto+Mono:300,300i,400,400i,500,500i,700,700i&amp;display=swap" rel="stylesheet">
        <script type="application/text" id="source">
          {"cells": [{"cell_type": "markdown", "metadata": {}, "source": ["# techscan devlog 2018-12-11\n", "", "2018-12-11 [#techscan](/tag/techscan.html) [#devlog](/tag/devlog.html) [#fintech](/tag/fintech.html)\n"]}, {"cell_type": "markdown", "metadata": {"tags": ["techscan", "devlog", "fintech"]}, "source": ["\n", "So some more progress this week, mostly optimization to existing jobs \u2013 I\n", "needed to get things running smoothly before I can concentrate on the new\n", "features I have planned. The issues for the new features are on gitea waiting\n", "to be tackled but accumulating too much technical debt makes in harder in the\n", "long run to get a smooth running system. Here\u2019s a summary of this devlog:\n", "\n", "## Bugfixes\n", "\n", "\u2013 stoch overfiring\n", "\u2013 fix premature exit in predictions\n", "\n", "## Optimization\n", "\n", "\u2013 Perf Eval runs in parallel now\n", "\u2013 parallel scans, ohlcv\n", "\u2013 Module run optimizations: don\u2019t run if no new data, don\u2019t sync if no data on\n", "IEX\n", "\u2013 Skip untriggered events in perf eval\n", "\u2013 Class property connections on dao\n", "\u2013 Parallel correlation proc\n", "\u2013 sql2o batching sux, implement grouped insert\n", "\u2013 Save ohlcv to KV store for faster access\n", "\u2013 track last scan date\n", "\u2013 extract exchange param (job pipeline optimization)\n", "\n", "## Experiments\n", "\n", "\u2013 Turtle exit for predictions\n", "\u2013 BBSqueeze detection change\n", "\n", "## New features\n", "\n", "\u2013 Bollinger/ma/ohlcv in KV store, display charts for scans\n", "\n", "## Bugfixes\n", "\n", "First off, a couple of bug fixes. Finding bugs in this system notoriously\n", "difficult as testing isn\u2019t done on behaviors but generated data. Verifying the\n", "data against a source of truth is quite time consuming and I only have a\n", "certain amount of time I can dedicate to manual testing. One of the defects\n", "that caught my attention this week was stochastic signals firing for both\n", "oversold and overbought on the same day, which is absolute non-sense. At first\n", "I thought it a date issue because the symbols I checked were from the top\n", "gainers and had huge increases that could pull up the stochastic from oversold\n", "to overbought in a day. My estimate was that the stochastic was oversold on day\n", "T-1 and became overbought on day T. But deeper investigation and hours of\n", "debugging showed that this was not the case. The triggering code for the\n", "indicator is fairly straight forward\n", "\n", "```\n", "if (def.srt.contains(\u201coverbought\u201d) && d[len \u2013 2] < ob && ob < d[len \u2013 1]) {\n", "\n", "return new ScanResult(data, def);\n", "\n", "}\n", "\n", "if (def.srt.contains(\u201coversold\u201d) && d[len \u2013 2] > os && os > d[len \u2013 1]) {\n", "\n", "return new ScanResult(data, def);\n", "\n", "}\n", "\n", "if (def.srt.contains(\u201cneutral\u201d) && (d[len \u2013 2] > ob && ob > d[len \u2013 1]) ||\n", "\n", "(d[len \u2013 2] < os && os < d[len \u2013 1])) {\n", "\n", "return new ScanResult(data, def);\n", "\n", "}\n", "```\n", "\n", "There is subtle bug in this code even though it looks quite simple. The 3rd\n", "condition: a & b | c. The precedence order is equal for both operators so it\n", "would trigger for both overbought and oversold\n", "\n", "\ufffc\n", "\n", "The correct code is a & (b | c). Yet again the great syntax of Java produces a\n", "bug that is easy to miss and will make you go blind in the process. Well it did\n", "cost a couple of hours but at least it was an easy fix.\n", "\n", "Another bug that I introduced during the performance evaluator developments\n", "came to light after I tackled some optimization tasks on that module. I was\n", "expecting way more scans to be score than there were which led me to\n", "investigate the scoring code that revealed a premature exit from the evaluation\n", "loop. A misplaced return statement instead of a continue statement was causing\n", "the loop to terminate early and not score the remaining predictions. Another\n", "easy fix at least.\n", "\n", "## Optimizations\n", "\n", "Optimizations were the meat of this weeks work. Originally I thought that\n", "running the modules on a single thread with good caching would suffice in terms\n", "of performance but I was wrong.\n", "\n", "So I went ahead to parallelize the portions of the modules that made sense.\n", "These were\n", "\n", "\u2013 Performance Evaluations\n", "\u2013 Scans\n", "\u2013 Correlations processing\n", "\n", "Thanks to Java 8 parallel streams this turned out to be quite easy. I just had\n", "to make sure that critical sections in code were atomic, and used classes that\n", "were thread safe. One aspect to take into consideration is to preserve the\n", "locality of the cache and not to evict items that from the cache only to have a\n", "second loop query that item again. So the order of processing is important.\n", "\n", "symbols -> combos -> dates\n", "\n", "will make sure that the cache contains the symbol data ready to be processed\n", "and will not run a DB query. Initially I had just parallelized the dates loop\n", "but that loop doesn\u2019t contain enough data to make it worth while. The CPU cores\n", "were only busy at 60% which is not ideal. So I moved the parallel streaming up\n", "2 levels to the symbol level which now utilized all cores at 100%. PerfEval and\n", "Scans use the same code base so that was a bit easier than the Correlation\n", "Processor that needed some extra attention due to memory issues. I operate\n", "under a RAM constraint (because I need to keep server costs to a minimum) so I\n", "needed to implement a specific cache for correlation calculations that just\n", "holds the last 30 closing prices and symbols.\n", "\n", "The seconds area of optimization was for syncing data from IEX and running\n", "scans on the synced data. I currently orchestrate the module jobs via Jenkins\n", "and the pipeline only supports triggering based on a fail/success return code.\n", "This means that every time I run a sync job, a scan job will trigger on success\n", "\u2013 even if there is no new data. It will just calculate the same results over\n", "and over again. This wasn\u2019t really a problem when the scan job only took a\n", "couple of minutes to complete with 1 years worth of data but it doesn\u2019t work\n", "with 5 years of data. So I implemented a check on the scan module that will\n", "only run the scans if the latest scan date for a symbol is less than the latest\n", "OHLC date. The job will still run but it will just skip the scans so it takes\n", "only about 3 \u2013 4 minutes to complete as opposed to 1 \u2013 1.5 hours. Another issue\n", "is with IEX not clearly defining when they will update the API with the days\n", "stock data. Previously I was fetching the data at 7 pm and 11 pm local time and\n", "processing the data even if the data was old (the one at 7 pm, they would have\n", "the data updated by 11 pm for sure). But this means that the new scans/signals\n", "are not shown until almost 12 am which is less than ideal. I didn\u2019t want to\n", "check every hour or two because it would trigger the whole job pipeline and\n", "it\u2019s a lot of data to download. My solution to this came after I discovered an\n", "API endpoint that listed the symbols, which had a date field that showed the\n", "time it was updated. Why didn\u2019t I just check a symbol for the last date?\n", "because at any given date a symbol may not be traded. The probability that AAPL\n", "not being traded is rather low, but still I prefer a robust solution if there\n", "is one. The cost of making this API call to the symbol list is low, so now I\n", "poll every hour for new data between 4 pm \u2013 11 pm on the week days. There is\n", "still no way to abort the pipe line without a failure on Jenkins but with the\n", "scan checking this is now less of a problem.\n", "\n", "A huge pain point was the duration of the Performance evaluation. I realized\n", "this week that I was doing a lot unnecessary processing that was causing the\n", "job to take forever. I only needed to calculate performance for the scans that\n", "had been triggered for that symbol, and I was running all the scans for that\n", "symbol. Duh!\n", "\n", "\ufffc\n", "\n", "With a new filter that skips scans that are not relevant and parallel\n", "processing the performance evaluation now takes 1 hour to complete which is\n", "reasonable. Even though I won\u2019t be running this job that often it kind of\n", "became my holy grail to optimize this. So looking back at the comments on the\n", "issue on gitea the first iteration resulted in 1K scored scans and 6K unscored\n", "(this was due to the bug I mentioned previously, which at the time I didn\u2019t\n", "know). This was way to little so I thought I\u2019d throw more data at it and\n", "increased the data interval to 5 years from 1. This increase resulted in 2.4K\n", "vs 6K. Still not good enough. After fixing the premature loop termination issue\n", "the final ratio is 5K/6K which to me looks OK. It is possible that some scans\n", "just didn\u2019t occur frequent enough to be scored.\n", "\n", "The DAO layer also got some love this week. I had previously implemented the\n", "DAO\u2019s in a way that each operation would open a new connection to the DB even\n", "though this is not good practice. I didn\u2019t want to integrate a connection\n", "pooling solution as the processes are not long lived so I just refactored the\n", "connection objects to be reused class wide. I\u2019m using a relatively new SQL\n", "library called sql2o which has a nice plain API for DB operations but the way\n", "they implemented batch insertions is not optimal. It just wraps the inserts\n", "around a transaction and still inserts each row individually. MySQL\u2019s grouped\n", "insert performs much better than this so I refactored batch inserts to generate\n", "a grouped insert query. This increased performance of the inserts quite a bit,\n", "even though I didn\u2019t measure by how much.\n", "\n", "After examining the MySQL advisor on PhpMyAdmin I saw that it complained about\n", "a lot of row sorting. The culprit was that each query to the OHLCV table needed\n", "a sort by date for the caching and range query to work properly. The problem\n", "here is that I already got the data sorted from the data API and lost that\n", "information after the insertion into the OHLCV table. I though about getting\n", "rid of the table and querying from the JSON data directly but some of the\n", "functions in the TOP module and market overview module take advantage of this\n", "table to reduce the amount of code and off load processing to the database, so\n", "the table had to stay. I stored the API response in K/V store only for query by\n", "the ChartData component for caching. I also saw that selecting the last scan\n", "date from the scan_result table for doing full table scans so I save those in\n", "the K/V store too. This type of optimization can be good for performance but\n", "it\u2019s important not to let these data points get out of sync. I also implemented\n", "a fall back mechanism to querying the DB if the value was not found in the K/V\n", "store. This case can occur if a symbol is introduced and the last scan date is\n", "not yet inserted.\n", "\n", "The Jenkins job pipeline also needs to be separated by exchange to reduce the\n", "amount of processing. This can be achieved by extracting the exchange parameter\n", "as a CLI parameter to the jobs. No need to run scans for IEX after BFX data\n", "synced, just run the BFX scans\n", "\n", "\ufffc\n", "\n", "## Experiments\n", "\n", "I decided to change the way the prediction checker scores scans. My initial\n", "implementation was exit on +/- 2 x ATR of the symbol. This yielded around 50%\n", "average scores. Next I tried a 15 period low/high exit strategy. There is\n", "really no correct way of doing this, as strategy is very personal. My reasoning\n", "was that on an up trend the 15 period low would still decent gains and on a\n", "down trend it would exit quite early to cut losses. After the performance\n", "evaluation runs the average score was 0.23959762958591568 and average error was\n", "0.17946781069881107 for a 95% confidence.\n", "\n", "I will still run the strategies of 2xATR, 3xATR and a percentage based exit to\n", "determine their outputs. Maybe running multiple strategies and selecting the\n", "best performing one and showing that could also be a nice feature, but again\n", "it\u2019s very personal. I believe a 1:1 take profit / stop loss ratio will result\n", "in an average score of around 50%, and 2:1 will result with an average score of\n", "33% as it\u2019s basically based on expected value since the price changes are\n", "distributed randomly.\n", "\n", "I also changed the way the Bollinger Bands squeeze scan was working. It was\n", "scanning the last N periods and triggering if the last period bands were within\n", "a certain limit of the minimum band width of the last N periods. This is kind\n", "of over complicated as I just want to get the periods were the bandwidth is\n", "low, so now it will trigger if the bandwidth is < 4%.\n", "\n", "## New features\n", "\n", "As I was sifting through the scans I realized that I was looking for a chart to\n", "see the relevant data that triggered the scan. If the scan is a Bollinger Bands\n", "squeeze I wanted to the bands on the chart. So I added this feature. This\n", "required me to store the band data in the K/V store because that\u2019s the only\n", "storage the API will access. To be consistent I also stored the last 100 period\n", "OHLC data in the K/V store to generate the candle stick data for the chart. The\n", "K/V store is backed by MySQL but this may change in the future. Redis is a\n", "strong contender for K/V storage, but I\u2019ll cross that bridge when I get there.\n", "I added a new field to the scan definitions file that defines which indicators\n", "will shown on the chart when that scan is triggered.\n", "\n", "Here is a screenshot of this new feature in action:\n", "\n", "![](/img/ts1.png)\n", "\n", "Wow, yet another very long post for a short week. Looks like a lot has been\n", "done and development is going full steam ahead.\n"]}], "metadata": {"celltoolbar": "Tags", "kernelspec": {"display_name": "Python 3", "language": "python", "name": "python3"}, "language_info": {"codemirror_mode": {"name": "ipython", "version": 3}, "file_extension": ".py", "mimetype": "text/x-python", "name": "python", "nbconvert_exporter": "python", "pygments_lexer": "ipython3", "version": "3.6.13"}}, "nbformat": 4, "nbformat_minor": 4}
        </script>
    </head>
    <body>
        <div id="main">
            <div class="header">
            <div style="position: absolute; left:10px; top:5px;">
              <a href="/blog/about.html">about</a>
              <a href="/micro/micro.html">micro</a>
              <a href="/blogindex.html">macro</a>
            </div>
            <h1>Deniz's Weblog</h1>
            <p style="font-family: monospace;">
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
            </p>
            </div>
            <div id="notebook-holder"></div>
            <hr/>
            <div>
              <em>Generated on 2021-08-22 11:26:49</em>
            </div>
            <p>
              Questions or comments? Please take the time to compose an email and send it to <a href="mailto:deniz.dizman@gmail.com?subject=Question/Comment">me</a>.
              I will update the relevant page with our correspondence.
            </p>
        </div>
        <script>
          var src = document.getElementById("source");
          var notebook = nb.parse(JSON.parse(src.innerText));
          var rendered = notebook.render();
          document.getElementById("notebook-holder").appendChild(rendered);
        </script>
    </body>
</html>
