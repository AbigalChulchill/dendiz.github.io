<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Deniz's personal pages</title>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1">
        <script src="/js/vendor/es5-shim.min.js"></script>
        <script src="/js/vendor/marked.min.js"></script>
        <!--script src="/js/vendor/purify.min.js"></script-->
        <script src="/js/vendor/ansi_up.min.js"></script>
        <script src="/js/vendor/prism.min.js"></script>
        <script src="/js/vendor/katex.min.js"></script>
        <script src="/js/vendor/katex-auto-render.min.js"></script>
	<script src="/js/vendor/notebook.js?_=2021-09-03 23:03:01"></script>
        <link rel="stylesheet" href="/css/vendor/katex.min.css" />
        <link rel="stylesheet" href="/css/vendor/prism.css" />
	<link rel="stylesheet" href="/css/notebook.css?2021-09-03 23:03:01" />
	<link rel="stylesheet" href="/css/nbpreview.css?2021-09-03 23:03:01" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900|Roboto+Mono:300,300i,400,400i,500,500i,700,700i&amp;display=swap" rel="stylesheet">
        <script type="application/text" id="source">
          {"cells": [{"cell_type": "markdown", "metadata": {}, "source": ["# how to pokebot\n", "", "2007-01-01 [#programming](/tag/programming.html)\n"]}, {"cell_type": "markdown", "metadata": {"tags": ["programming"]}, "source": ["\n", "_This a historic document that I found somewhere on my hard drive. It's incomplete\n", "and the quality is very poor at best_\n", "\n", "## The devil: win32 API\n", "To capture the messages from the window of the poker client, had to be done with win api stuff. The other options that come to mind are:\n", "\n", "* decrypt the network traffic between the poker room client and server, which is probably impossible\n", "* screen scrape the poker room client, which i think is a bad idea and hard to implement error prone etc.\n", "\n", "So we need to hook various api functions, ExtTextout, DrawText, etc. Tutorial about this stuff on the web are quite scarce, after quite a while of searching i came up with two simple code examples:\n", "\n", "\n", "hookdll.c:\n", "\n", "```\n", "#include <windows.h>\n", "#include <string.h>\n", "#include <stdio.h>\n", "\n", "#pragma data_seg(\"hookdata\")\n", "HHOOK oldkeyhook = 0;\n", "#pragma data_seg()\n", "#pragma comment(linker, \"/SECTION:hookdata,RWS\")\n", "\n", "#define DllExport\u00a0 __declspec (dllexport)\n", "\n", "DllExport LRESULT CALLBACK KeyboardProc(int nCode, WPARAM wParam, LPARAM lParam);\n", "DllExport void InstallHook(int nCode);\n", "DllExport void EndHook();\n", "\n", "HINSTANCE hInst = NULL;\n", "\n", "BOOL APIENTRY DllMain(HINSTANCE hInstance,DWORD\u00a0 ul_reason_for_call,LPVOID lpReserved)\n", "{\n", "\u00a0\u00a0\u00a0 switch(ul_reason_for_call)\n", "\u00a0\u00a0\u00a0 {\n", "\u00a0\u00a0\u00a0 case DLL_PROCESS_ATTACH:\n", "\u00a0\t\u00a0\u00a0 hInst = hInstance;\n", "\u00a0\t\u00a0\u00a0 break;\n", "\u00a0\u00a0\u00a0 case DLL_PROCESS_DETACH:\n", "\u00a0\t\u00a0\u00a0 break;\n", "\u00a0\u00a0\u00a0 case DLL_THREAD_ATTACH:\n", "\u00a0\t\u00a0\u00a0 break;\n", "\u00a0\u00a0\u00a0 case DLL_THREAD_DETACH:\n", "\u00a0\t\u00a0\u00a0 break;\n", "\u00a0\u00a0\u00a0 }\n", "\u00a0\u00a0\u00a0 return TRUE;\n", "}\n", "\n", "void InstallHook(int nCode)\n", "{\n", "\u00a0\u00a0\u00a0 oldkeyhook = SetWindowsHookEx(WH_KEYBOARD, (HOOKPROC)KeyboardProc, hInst, 0);\n", "}\n", "\n", "DllExport LRESULT CALLBACK KeyboardProc(int nCode, WPARAM wp, LPARAM lp)\n", "{\n", "\u00a0\u00a0\u00a0 FILE *fp;\n", "\u00a0\u00a0\u00a0 if (nCode >= 0)\n", "\u00a0\u00a0\u00a0 {\u00a0\t\u00a0\u00a0\n", "\u00a0\t\u00a0\u00a0 if ((lp & 0x80000000) == 0x80000000)\n", "\u00a0\t\u00a0\u00a0 {\n", "\u00a0\t\t\u00a0\u00a0 fp = fopen(\"C:\\\\keys.txt\",\"a+\");\n", "\u00a0\t\t\u00a0\u00a0 char lpszName[0x100] = {0};\n", "\u00a0\t\t\u00a0\u00a0 GetKeyNameText(lp,lpszName,0xFF);\n", "\u00a0\t\t\u00a0\u00a0 fwrite(lpszName,strlen(lpszName),1, fp);\n", "\u00a0\t\t\u00a0\u00a0 fclose(fp);\u00a0\t\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 }\u00a0\u00a0\u00a0\n", "\u00a0\u00a0 }\n", "\u00a0\u00a0 return CallNextHookEx(oldkeyhook,nCode,wp,lp);\n", "}\n", "void EndHook(void)\n", "{\n", "\u00a0\u00a0\u00a0 UnhookWindowsHookEx(oldkeyhook);\n", "}\n", "```\n", "\n", "hookexe.c:\n", "\n", "```\n", "#include <windows.h>\n", "\n", "LRESULT CALLBACK WindowProcedure (HWND, UINT, WPARAM, LPARAM);\n", "char szClassName[ ] = \"mTn\";\n", "\n", "int WINAPI WinMain (HINSTANCE hThisInstance,\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 HINSTANCE hPrevInstance,\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 LPSTR lpszArgument,\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 int nFunsterStil)\n", "\n", "{\n", "\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 MSG messages;\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 WNDCLASSEX wincl;\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 HWND hwnd;\u00a0\n", "\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 wincl.hInstance = hThisInstance;\n", "\u00a0\u00a0\u00a0 wincl.lpszClassName = szClassName;\n", "\u00a0\u00a0\u00a0 wincl.lpfnWndProc = WindowProcedure;\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 wincl.style = CS_DBLCLKS;\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 wincl.cbSize = sizeof (WNDCLASSEX);\n", "\n", "\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 wincl.hIcon = LoadIcon (NULL, IDI_APPLICATION);\n", "\u00a0\u00a0\u00a0 wincl.hIconSm = LoadIcon (NULL, IDI_APPLICATION);\n", "\u00a0\u00a0\u00a0 wincl.hCursor = LoadCursor (NULL, IDC_ARROW);\n", "\u00a0\u00a0\u00a0 wincl.lpszMenuName = NULL;\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 wincl.cbClsExtra = 0;\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 wincl.cbWndExtra = 0;\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 wincl.hbrBackground = (HBRUSH) COLOR_BACKGROUND;\n", "\n", "\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 if (!RegisterClassEx (&wincl))\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 return 0;\n", "\n", "\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 hwnd = CreateWindowEx (\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 0,\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 szClassName,\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \"mTn keyb hook\",\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 WS_OVERLAPPEDWINDOW,\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 CW_USEDEFAULT,\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 CW_USEDEFAULT,\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 190,\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 58,\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 HWND_DESKTOP,\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 NULL,\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 hThisInstance,\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 NULL\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 );\n", "\n", "\u00a0\u00a0\u00a0 ShowWindow (hwnd, nFunsterStil);\n", "\n", "\u00a0\u00a0\u00a0 while (GetMessage (&messages, NULL, 0, 0))\n", "\u00a0\u00a0\u00a0 {\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 TranslateMessage(&messages);\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 DispatchMessage(&messages);\n", "\u00a0\u00a0\u00a0 }\n", "\u00a0\u00a0\u00a0 return (int)messages.wParam;\n", "}\n", "\n", "LRESULT CALLBACK WindowProcedure (HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)\n", "{\n", "\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 HWND hButton;\n", "\u00a0\u00a0\u00a0 HWND hButton1;\n", "\u00a0\u00a0\u00a0 static HMODULE hInsDll;\n", "\u00a0\u00a0\u00a0 HFONT hfDefault;\n", "\u00a0\u00a0\u00a0 void (*pInstallHook)(int);\n", "\u00a0\u00a0\u00a0 void (*pUninstallHook)(void);\n", "\u00a0\u00a0\u00a0 switch (message)\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0 {\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\t\u00a0\u00a0 case WM_DESTROY:\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 PostQuitMessage (0);\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 break;\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 case WM_CREATE:\n", "\u00a0\t\t\u00a0\u00a0 hfDefault = (HFONT)GetStockObject(DEFAULT_GUI_FONT);//Sistem fontunu al\u00fdr\n", "\u00a0\t\t\u00a0\u00a0 hButton =\u00a0 CreateWindow(\"button\",\"HOOK ET\",WS_CHILD | WS_VISIBLE | BS_PUSHBUTTON | WS_TABSTOP,0,0,80,24,hwnd,(HMENU)1001,((LPCREATESTRUCT)(lParam))->hInstance,NULL);\n", "\u00a0\t\t\u00a0\u00a0 SendMessage(hButton, WM_SETFONT, (WPARAM)hfDefault, MAKELPARAM(FALSE, 0)); //sistem fontunu kulland\u00fdr\u00fdr\n", "\u00a0\t\t\u00a0\u00a0 hButton1 =\u00a0 CreateWindow(\"button\",\"BIRAK\",WS_CHILD | WS_VISIBLE | BS_PUSHBUTTON | WS_TABSTOP,90,0,90,24,hwnd,(HMENU)1002,((LPCREATESTRUCT)(lParam))->hInstance,NULL);\n", "\u00a0\t\t\u00a0\u00a0 SendMessage(hButton1, WM_SETFONT, (WPARAM)hfDefault, MAKELPARAM(FALSE, 0)); //sistem fontunu kulland\u00fdr\u00fdr\n", "\u00a0\t\t\u00a0\u00a0 hInsDll = LoadLibrary(\"kbHookDll.dll\");\n", "\u00a0\t\t\u00a0\u00a0 break;\n", "\u00a0\t\u00a0\u00a0 case WM_COMMAND:\n", "\u00a0\t\t\u00a0\u00a0 switch(LOWORD(wParam))\n", "\u00a0\t\t\u00a0\u00a0 {\n", "\u00a0\t\t\t\u00a0\u00a0 case 1001:\n", "\u00a0\t\t\t\t\u00a0\u00a0 pInstallHook = (void (*)(int))GetProcAddress(hInsDll, \"InstallHook\");\n", "\u00a0\t\t\t\t\u00a0\u00a0 pInstallHook(TRUE);\n", "\u00a0\t\t\t\t\u00a0\u00a0 break;\n", "\n", "\u00a0\t\t\t\u00a0\u00a0 case 1002:\n", "\u00a0\t\t\t\t\u00a0\u00a0 pUninstallHook = (void(*)(void))GetProcAddress(hInsDll,\"EndHook\");\n", "\u00a0\t\t\t\t\u00a0\u00a0 pUninstallHook();\n", "\u00a0\t\t\t\t\u00a0\u00a0 break;\n", "\u00a0\t\t\u00a0\u00a0 }\n", "\u00a0\t\t\u00a0\u00a0 break;\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 default:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 return DefWindowProc (hwnd, message, wParam, lParam);\n", "\u00a0\u00a0\u00a0 }\n", "\u00a0\u00a0\u00a0 return 0;\n", "}\n", "```\n", "\n", "\n", "The exe file injects a system wide hook dll that intercepts the keyboard keypress api call and logs the key pressed into a file. A very simple key-logger if you will. The codes logic is pretty simple i think, you just reroute the original api call to yours, do the stuff you want and then call the original api method. The method used here is a method provided by the windows api, so there is nothing illegitimate with the method. But thebad news is that this type of hooking is only supported for hooking messages between windows and not gdi32 api calls, which we need. So we can't use this method on a poker room client, that disguises its log text\n", "\n", "\n", "## Trying it Under Wine\n", "\n", "After failed attemps on win32 API programming I came up with the ingenious idea of running the poker desktop clients on linux, under the wine win32 API emulator.\u00a0 We had a discussion about the pro/cons of this approach.\n", "Pros:\n", "* wine is open source, so easy access to the API implementation to override custom windows stealth behaviours.\n", "* No need to avoid poker room clients detection attempts, everything is in the wine source code\n", "Linux environment\n", "\n", "Cons:\n", "* Probably no source code to examine, need to hack wine codes by ourselves\n", "* User input simulation still remains a mystery\n", "\n", "\n", "Installing wine under debian etch, was quite easy. I just grabbed the source from the sourceforge page and untarred it. The configure script keeps bugging you for the dependencies, which where lib-png, lib-jpeg, flex, bison, libxml2 for me,on a minimal desktop installation of debian. The build time takes quite a while, ~1,5 million lines of code, but completes without errors.\n", "Next up, download the pokerroom executable from their page, and run it under wine. Wine complained about missing DLLs such as mfc 4.2 and visual C runtime files. To satisfy this hunger we used winetricks from http://www.kegel.com/winetricks which is a small script that downloads and install the dependecy DLLs.\n", "When you fire up wine, the poker room client executes complaining about some DLL being old, which is not important. After you try to login, it says that it can't connect to the login server. This is because wine hardware ID's are blacklisted. To overcome this, you need to patch wine to report a different hardware id. Here is the patch for version 0.9.30:\n", "\n", "\n", "```\n", "diff -uNr wine-0.9.30-fe/dlls/advapi32/advapi.c wine-0.9.30-fe-patched/dlls/advapi32/advapi.c\n", "--- wine-0.9.30-fe/dlls/advapi32/advapi.c\t2007-01-25 07:53:50.000000000 -0800\n", "+++ wine-0.9.30-fe-patched/dlls/advapi32/advapi.c\t2007-02-22 16:50:15.000000000 -0800\n", "@@ -112,11 +112,57 @@\n", "*/\n", "BOOL WINAPI GetCurrentHwProfileA(LPHW_PROFILE_INFOA pInfo)\n", "{\n", "-\tFIXME(\"(%p) semi-stub\\n\", pInfo);\n", "-\tpInfo->dwDockInfo = DOCKINFO_DOCKED;\n", "-\tstrcpy(pInfo->szHwProfileGuid,\"{12340001-1234-1234-1234-1233456789012}\");\n", "-\tstrcpy(pInfo->szHwProfileName,\"Wine Profile\");\n", "-\treturn 1;\n", "+       CHAR profile[32];\n", "+       DWORD type;\n", "+       DWORD size;\n", "+       DWORD ret;\n", "+       DWORD val;\n", "+       HKEY hkey;\n", "+       BOOL profile_result = 0;\n", "+\n", "+       ret = RegOpenKeyA(HKEY_LOCAL_MACHINE, \"System\\\\CurrentControlSet\\\\Control\\\\IDConfigDB\",\n", "+                         &hkey);\n", "+\n", "+       if (ret != ERROR_SUCCESS)\n", "+               goto profile_error;\n", "+\n", "+       ret = RegGetValueA(hkey, NULL, \"CurrentConfig\", RRF_RT_DWORD,\n", "+                          &type, &val, &size);\n", "+       if (ret != ERROR_SUCCESS || size != 4 || type != REG_DWORD)\n", "+               goto profile_error;\n", "+\n", "+       /* At least, I think the profile names are hex */\n", "+       sprintf(profile, \"Hardware Profiles\\\\%04x\", (WORD)(val & 0xffff));\n", "+\n", "+       /* Set the profile name */\n", "+       size = MAX_PROFILE_LEN;\n", "+       ret = RegGetValueA(hkey, profile, \"FriendlyName\", RRF_RT_REG_SZ,\n", "+                          &type, pInfo->szHwProfileName, &size);\n", "+\n", "+       if (ret != ERROR_SUCCESS || type != REG_SZ)\n", "+               goto profile_error;\n", "+\n", "+       /* Now get the GUID of this profile */\n", "+       size = HW_PROFILE_GUIDLEN;\n", "+       ret = RegGetValueA(hkey, profile, \"HwProfileGuid\", RRF_RT_REG_SZ,\n", "+                          &type, pInfo->szHwProfileGuid, &size);\n", "+\n", "+       if (ret != ERROR_SUCCESS || type != REG_SZ)\n", "+               goto profile_error;\n", "+\n", "+       /* And finally the docking state */\n", "+       ret = RegGetValueA(hkey, \"CurrentDockInfo\", \"DockingState\", RRF_RT_DWORD,\n", "+                          &type, &pInfo->dwDockInfo, &size);\n", "+\n", "+       if (ret != ERROR_SUCCESS || size != 4 || type != REG_DWORD)\n", "+               goto profile_error;\n", "+\n", "+       /* Success */\n", "+      profile_result = 1;\n", "+\n", "+profile_error:\n", "+       RegCloseKey(hkey);\n", "+      return profile_result;\n", "}\n", "\n", "/******************************************************************************\n", "diff -uNr wine-0.9.30-fe/tools/wine.inf wine-0.9.30-fe-patched/tools/wine.inf\n", "--- wine-0.9.30-fe/tools/wine.inf\t2007-01-25 07:53:50.000000000 -0800\n", "+++ wine-0.9.30-fe-patched/tools/wine.inf\t2007-02-22 16:51:03.000000000 -0800\n", "@@ -237,6 +237,22 @@\n", "HKLM,System\\CurrentControlSet\\Control\\Session Manager\\Environment,\"windir\",,\"%10%\"\n", "HKLM,System\\CurrentControlSet\\Control\\Session Manager\\Environment,\"winsysdir\",,\"%11%\"\n", "\n", "+[IDConfigDB]\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB,\"CurrentConfig\",,0x00000000\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB,\"UserWaitInterval\",,0x0000001e\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB,\"IsPortable\",,0x00000000\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB\\Alias\\0000,\"DockingState\",,0x00000000\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB\\Alias\\0000,\"Capabilities\",,0x00000000\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB\\Alias\\0000,\"DockID\",,0x00000000\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB\\Alias\\0000,\"SerialNumber\",,0x00000000\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB\\Alias\\0000,\"ProfileNumber\",,0x00000000\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB\\Hardware Profiles,\"Unknown\",,0x00000000\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB\\Hardware Profiles\\0000,\"PreferenceOrder\",,0x00000000\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB\\Hardware Profiles\\0000,\"FriendlyName\",,\"Wine Profile\"\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB\\Hardware Profiles\\0000,\"Aliasable\",,0x00000000\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB\\Hardware Profiles\\0000,\"Cloned\",,0x00000000\n", "+HKLM,System\\CurrentControlSet\\Control\\IDConfigDB\\Hardware Profiles\\0000,\"HwProfileGuid\",,\"{abba0009-1ed34-1dad4-1333-1e3e4ebb890a}\"\n", "+\n", "[Fonts]\n", "HKLM,%FontSubStr%,\"Arial CE,238\",,\"Arial,238\"\n", "HKLM,%FontSubStr%,\"Arial CYR,204\",,\"Arial,204\"\n", "```\n", "\n", "cd into the wine source installation directory and apply the patch with\n", "\n", "```\n", "patch -p0 < patch.txt\n", "```\n", "\n", "\n", "Next you need to install some registry keys. Put the following into a text file and import with regedit file.txt.\n", "\n", "```\n", "REGEDIT4\n", "[HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\IDConfigDB]\n", "\"CurrentConfig\"=hex:00,00,00,00\n", "\"IsPortable\"=hex:00,00,00,00\n", "\"UserWaitInterval\"=hex:00,00,00,1e\n", "[HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\IDConfigDB\\Alias]\n", "[HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\IDConfigDB\\Alias\\0000]\n", "\"Capabilities\"=hex:00,00,00,00\n", "\"DockID\"=hex:00,00,00,00\n", "\"DockingState\"=hex:00,00,00,00\n", "\"ProfileNumber\"=hex:00,00,00,00\n", "\"SerialNumber\"=hex:00,00,00,00\n", "[HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\IDConfigDB\\Hardware Profiles]\n", "\"Unknown\"=hex:00,00,00,00\n", "[HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\IDConfigDB\\Hardware Profiles\\0000]\n", "\"Aliasable\"=hex:00,00,00,00\n", "\"Cloned\"=hex:00,00,00,00\n", "\"FriendlyName\"=\"Wine Profile\"\n", "\"HwProfileGuid\"=\"{abba0009-1ed34-1dad4-1333-1e3eb00a890a}\"\n", "\"PreferenceOrder\"=hex:00,00,00,00\n", "```\n", "\n", "Build the source code, and install it.\n", "After the installation process this is what you get:\n", "\n", "\n", "\n", "Now that wine works, we need to hook the text drawing functions to capture the game log and process it.\n", "Normally this would be an easy task under windows, but the poker rooms use tricks to prevent this from happening.\n", "They use custom windows that override the WM_GETTEXT function that should return the contents of a control, and make it return nothing. So we have to hook the text displaying portion of the operating systems API, in this case the wine API.\n", "This method resides in the file dlls/user32/text.c. For testing purposes add the following line into DrawTextExW():\n", "\n", "```\n", "FIXME(\"%s, %d, [%s] %08x\\n\", debugstr_wn (str, count), count,\n", "\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 wine_dbgstr_rect(rect), flags);\n", "```\n", "\n", "Now save the file and exit. Run the poker room client with wine, and watch the terminal output a lot of messages. Login to your account and sit at a table.\n", "If you watch the terminal log, you'll see messages flying by with every little piece of text that is ever drawn on to the wine windows. This includes the game log that we are interested in. Now there are a few problems that we can identify here:\n", "\n", "* we don't want to receive messages from the lobby windows, including garbage chat conversations.\n", "* Poker room developers tried make our lives harder by calling drawText for every word instead of sentences.\n", "* There are duplicate messages all over the place\n", "\n", "This is a screen shot of where we are now:\n", "\n", "![](/img/pokebot.png)\n", "\n", "## The Brain\n", "Before setting out to code and getting our hands dirty, the most scary part seemed to me the win 32 API stuff, probably because I've been a linux console/web programmer all my life, and i was never into windows and desktop client, especially low level - unmanaged windows API calls. But it seems there are a lot of resources and documents, and even managed code that hooks API calls (discussed in a different chapter). The real beast is the brain, the decision making part, the AI Server.\n", "\n", "First off before discussing the actual algorithms and techniques, lets dicuss the architecture, and why it is called the AI Server. Simple: we'll have multiple poker room clients, playing on mutliple tables, some times even 2 of our bots playing on the same table, and sharing data, though one might think that this would decrease the winnings, and giving more rake, but this would increase our chances of winning more money from the other players. AI algorithms should be changable and tunable on the fly, and yet per AI Client (the Agent) configurable. The best design decision seemed like a client/server model, where the server was the AI Server, and the clients were the agents, that were the gateway between the AI and the poker room client. The AI Server's architectural crude design is like this:\n", "[AIServer Diagram in Omnigraffle]\n", "\n", "Flexibilty is a key design objective in most of the projects that get designed. This also was the case in the AI Server. Different algorithms had to be pluggable as modules, changeable according to table characteristics (heretic players, tight players, etc.) without the need of recompilation of code.\n", "\n", "Multi-thread is a core requirement, because we'll be serving a lot of requests and clients\n", "\n", "Cheating and using a application container such as tomcat doesn't help because HTTP is a stateless protocol, and poker is a statefull game. The state will have to be carried out by URL parameters or session/cookies which means that the agent will need to implement a HTTP client, which is not worth the effort. Instead we designed our own text based communication protocol. The protocol is TCP and Text based. Very simple, clients send commands and the server threads act accordingly.\n", "\n"]}], "metadata": {"celltoolbar": "Tags", "kernelspec": {"display_name": "Python 3", "language": "python", "name": "python3"}, "language_info": {"codemirror_mode": {"name": "ipython", "version": 3}, "file_extension": ".py", "mimetype": "text/x-python", "name": "python", "nbconvert_exporter": "python", "pygments_lexer": "ipython3", "version": "3.6.12"}}, "nbformat": 4, "nbformat_minor": 4}
        </script>
    </head>
    <body>
        <div id="main">
            <div class="header">
            <div style="position: absolute; left:10px; top:5px;">
              <a href="/blog/about.html?2021-09-03 23:03:01">about</a>
              <a href="/micro/micro.html?2021-09-03 23:03:01">micro</a>
              <a href="/blogindex.html?2021-09-03 23:03:01">macro</a>
            </div>
            <h1>Deniz's Weblog</h1>
            <p style="font-family: monospace;">
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
                <!-- a class="inverted" href="/tag/.html">/</a-->
            </p>
            </div>
            <div id="notebook-holder"></div>
            <hr/>
            <div>
              <em>Generated on 2021-09-03 23:03:01</em>
            </div>
            <p>
              Questions or comments? Please take the time to compose an email and send it to <a href="mailto:deniz.dizman@gmail.com?subject=Question/Comment">me</a>.
              I will update the relevant page with our correspondence.
            </p>
        </div>
        <script>
          var src = document.getElementById("source");
          var notebook = nb.parse(JSON.parse(src.innerText));
          var rendered = notebook.render();
          document.getElementById("notebook-holder").appendChild(rendered);
        </script>
    </body>
</html>
